<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{% block title %}Network Dashboard{% endblock %}</title>
		<link
			rel="stylesheet"
			href="{{ url_for('static', filename='css/dashboard.css') }}"
		/>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
	</head>
	<body>
		<nav class="navbar">
			<div class="nav-container">
				<div class="nav-brand">
					<h1>Network Dashboard</h1>
				</div>
				<div class="nav-links">
					<a href="/" class="nav-link">Dashboard</a>
					<a href="/devices" class="nav-link">Devices</a>
					<button id="scan-btn" class="scan-button">Scan Network</button>
				</div>
			</div>
		</nav>

		<main class="main-content">{% block content %}{% endblock %}</main>

		<div id="notification" class="notification hidden">
			<span id="notification-message"></span>
			<button id="notification-close" class="notification-close">
				&times;
			</button>
		</div>

		<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
		<script>
			// Initialize Socket.IO connection
			const socket = io();

			// Global notification system
			function showNotification(message, type = "info") {
				const notification = document.getElementById("notification");
				const messageElement = document.getElementById("notification-message");

				messageElement.textContent = message;
				notification.className = `notification ${type}`;
				notification.classList.remove("hidden");

				setTimeout(() => {
					notification.classList.add("hidden");
				}, 5000);
			}

			// Close notification
			document
				.getElementById("notification-close")
				.addEventListener("click", () => {
					document.getElementById("notification").classList.add("hidden");
				});

			// Scan button functionality
			document
				.getElementById("scan-btn")
				.addEventListener("click", async () => {
					const scanBtn = document.getElementById("scan-btn");
					scanBtn.disabled = true;
					scanBtn.textContent = "Scanning...";

					try {
						const response = await fetch("/api/scan", { method: "POST" });
						const data = await response.json();

						if (data.success) {
							showNotification("Network scan started", "success");
						} else {
							showNotification(data.error, "error");
							scanBtn.disabled = false;
							scanBtn.textContent = "Scan Network";
						}
					} catch (error) {
						showNotification("Failed to start scan", "error");
						scanBtn.disabled = false;
						scanBtn.textContent = "Scan Network";
					}
				});

			// Socket.IO event handlers
			socket.on("scan_started", (data) => {
				showNotification(data.message, "info");
			});

			socket.on("scan_completed", (data) => {
				showNotification(
					`Scan completed: ${data.devices_found} devices found`,
					"success",
				);
				document.getElementById("scan-btn").disabled = false;
				document.getElementById("scan-btn").textContent = "Scan Network";

				// Refresh page data
				if (typeof refreshData === "function") {
					refreshData();
				}
			});

			socket.on("scan_error", (data) => {
				showNotification(`Scan error: ${data.error}`, "error");
				document.getElementById("scan-btn").disabled = false;
				document.getElementById("scan-btn").textContent = "Scan Network";
			});

			socket.on("connected", (data) => {
				console.log("Connected to server:", data.message);
			});
		</script>

		{% block scripts %}{% endblock %}
	</body>
</html>
