{% extends 'base.html' %}
{% block content %}
<h2>Device Details</h2>
<table class="table table-bordered">
  <tbody>
    <tr><th>IP Address</th><td>{{ device.ip_address }}</td></tr>
    <tr><th>MAC Address</th><td>{{ device.mac_address }}</td></tr>
    <tr><th>Hostname</th><td>{{ device.hostname }}</td></tr>
    <tr><th>Vendor</th><td>{{ device.vendor }}</td></tr>
    <tr><th>Device Type</th><td>{{ device.device_type }}</td></tr>
    <tr><th>Last Seen</th><td>{{ device.last_seen }}</td></tr>
    <tr><th>Open Ports</th><td>{% if device.open_ports %}{{ device.open_ports|join(', ') }}{% else %}None{% endif %}</td></tr>
    <tr><th>Scan Method</th><td>{{ device.method }}</td></tr>
  </tbody>
</table>

<hr>
<h3>Remote Command Execution</h3>
<form id="command-form" style="margin-bottom: 1em;">
  <div class="form-group">
    <label for="cmd-username">Username:</label>
    <input type="text" id="cmd-username" class="form-control" required>
  </div>
  <div class="form-group">
    <label for="cmd-password">Password:</label>
    <input type="password" id="cmd-password" class="form-control" required>
  </div>
  <button type="submit" class="btn btn-primary">Connect to Terminal</button>
</form>

<!-- Modal Terminal Popup -->
<div id="terminal-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#181818;color:#eee;min-width:500px;min-height:350px;max-width:90vw;max-height:90vh;position:relative;box-shadow:0 2px 24px #000;border-radius:8px;display:flex;flex-direction:column;">
    <button id="close-terminal" style="position:absolute;top:10px;right:16px;background:none;border:none;color:#fff;font-size:1.5em;cursor:pointer;">&times;</button>
    <div style="padding:1.5em 1.5em 0.5em 1.5em;flex:1;display:flex;flex-direction:column;">
      <div id="terminal-output" style="background:#222;color:#eee;padding:1em;flex:1;overflow-y:scroll;min-height:200px;max-height:60vh;font-family:monospace;font-size:1em;border-radius:4px;"></div>
      <form id="terminal-cmd-form" style="display:flex;margin-top:1em;">
        <input type="text" id="terminal-cmd-input" placeholder="Enter command..." style="flex:1;padding:0.5em;font-size:1em;border-radius:4px 0 0 4px;border:1px solid #444;background:#222;color:#eee;outline:none;">
        <button type="submit" style="padding:0.5em 1.2em;font-size:1em;border:none;background:#007bff;color:#fff;border-radius:0 4px 4px 0;cursor:pointer;">Send</button>
      </form>
    </div>
  </div>
</div>

<a href="/devices" class="btn btn-secondary">Back to Devices</a>

<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io();
const form = document.getElementById('command-form');
const modal = document.getElementById('terminal-modal');
const closeBtn = document.getElementById('close-terminal');
const terminalOutput = document.getElementById('terminal-output');
const terminalCmdForm = document.getElementById('terminal-cmd-form');
const terminalCmdInput = document.getElementById('terminal-cmd-input');
let sessionPayload = null;

form.addEventListener('submit', function(e) {
  e.preventDefault();
  // Save credentials for session
  sessionPayload = {
    ip: "{{ device.ip_address }}",
    username: document.getElementById('cmd-username').value,
    password: document.getElementById('cmd-password').value,
    os: "{{ device.device_type|lower }}"
  };
  terminalOutput.textContent = "Connecting to remote terminal...\n";
  modal.style.display = 'flex';
  // Send a special connect event
  socket.emit('terminal_connect', sessionPayload);
});

closeBtn.addEventListener('click', function() {
  modal.style.display = 'none';
  terminalOutput.textContent = '';
  socket.emit('terminal_disconnect', sessionPayload);
});

terminalCmdForm.addEventListener('submit', function(e) {
  e.preventDefault();
  const cmd = terminalCmdInput.value.trim();
  if (!cmd) return;
  terminalOutput.textContent += `\n> ${cmd}\n`;
  socket.emit('terminal_command', { ...sessionPayload, command: cmd });
  terminalCmdInput.value = '';
});

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
function appendTerminalOutput(text) {
  // Replace newlines with <br> and preserve spaces
  const html = escapeHtml(text).replace(/\n/g, '<br>').replace(/  /g, ' &nbsp;');
  const isAtBottom = Math.abs(terminalOutput.scrollHeight - terminalOutput.scrollTop - terminalOutput.clientHeight) < 5;
  terminalOutput.innerHTML += html;
  // Only auto-scroll if user was already at the bottom
  if (isAtBottom) {
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
  }
}
socket.on('terminal_output', function(data) {
  appendTerminalOutput(data.output);
});
socket.on('terminal_error', function(data) {
  appendTerminalOutput(`\n[Error] ${data.error}`);
});
socket.on('terminal_connected', function(data) {
  appendTerminalOutput('\n[Connected to remote terminal]\n');
});
socket.on('terminal_disconnected', function(data) {
  appendTerminalOutput('\n[Disconnected from remote terminal]\n');
});
</script>
{% endblock %}
