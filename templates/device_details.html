{% extends 'base.html' %}
{% block content %}
<h2>Device Details</h2>
<table class="table table-bordered">
  <tbody>
    <tr><th>IP Address</th><td>{{ device.ip_address }}</td></tr>
    <tr><th>MAC Address</th><td>{{ device.mac_address }}</td></tr>
    <tr><th>Hostname</th><td>{{ device.hostname }}</td></tr>
    <tr><th>Vendor</th><td>{{ device.vendor }}</td></tr>
    <tr><th>Device Type</th><td>{{ device.device_type }}</td></tr>
    <tr><th>Last Seen</th><td>{{ device.last_seen }}</td></tr>
    <tr><th>Open Ports</th><td>{% if device.open_ports %}{{ device.open_ports|join(', ') }}{% else %}None{% endif %}</td></tr>
    <tr><th>Scan Method</th><td>{{ device.method }}</td></tr>
  </tbody>
</table>

<hr>
<h3>Remote Command Execution</h3>
<form id="command-form" style="margin-bottom: 1em;">
  <div class="form-group">
    <label for="cmd-username">Username:</label>
    <input type="text" id="cmd-username" class="form-control" required>
  </div>
  <div class="form-group">
    <label for="cmd-password">Password:</label>
    <input type="password" id="cmd-password" class="form-control" required>
  </div>
  <div class="form-group">
    <label for="cmd-command">Command:</label>
    <input type="text" id="cmd-command" class="form-control" required>
  </div>
  <button type="submit" class="btn btn-primary">Run Command</button>
</form>
<pre id="cmd-output" style="background:#222;color:#eee;padding:1em;min-height:4em;"></pre>

<a href="/devices" class="btn btn-secondary">Back to Devices</a>

<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io();
const form = document.getElementById('command-form');
const output = document.getElementById('cmd-output');
form.addEventListener('submit', function(e) {
  e.preventDefault();
  output.textContent = "Connecting and running command...\n";
  const payload = {
    ip: "{{ device.ip_address }}",
    username: document.getElementById('cmd-username').value,
    password: document.getElementById('cmd-password').value,
    command: document.getElementById('cmd-command').value,
    os: "{{ device.device_type|lower }}"
  };
  console.log('[DEBUG] Emitting run_command:', payload);
  socket.emit('run_command', payload);
});
socket.on('command_output', function(data) {
  console.log('[DEBUG] Received command_output:', data);
  output.textContent += data.output;
});
socket.on('command_done', function(data) {
  console.log('[DEBUG] Received command_done:', data);
  output.textContent += "\n[Command finished]";
});
socket.on('command_error', function(data) {
  console.log('[DEBUG] Received command_error:', data);
  output.textContent += "\n[Error] " + data.error;
});
</script>
{% endblock %}
